{% extends "components/_main.jinja" %}

{% block title %}Site Customization - Admin{% endblock %}

{% block head_extra %}
<!-- CodeMirror CSS for code editor -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

<style>
    .editor-container {
        border: 2px solid var(--card-border);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .CodeMirror {
        height: 300px;
        font-size: 14px;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .section-header {
        background: var(--card);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 2rem 0 1rem 0;
        border-left: 4px solid var(--cyan);
    }
    
    .section-header h2 {
        margin: 0;
        color: var(--cyan);
        font-size: 1.5rem;
    }
    
    .section-header p {
        margin: 0.5rem 0 0 0;
        color: var(--muted);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-field {
        margin-bottom: 1.5rem;
    }
    
    .form-field label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text);
    }
    
    .form-field input[type="text"],
    .form-field input[type="email"],
    .form-field input[type="color"],
    .form-field input[type="file"],
    .form-field textarea {
        width: 100%;
        padding: 0.75rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 5px;
        color: var(--text);
        font-size: 1rem;
    }
    
    .form-field input[type="file"] {
        padding: 0.5rem;
        cursor: pointer;
    }
    
    .form-field input[type="color"] {
        height: 50px;
        cursor: pointer;
        padding: 0.25rem;
    }
    
    .form-field textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }
    
    .checkbox-field {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--card);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .checkbox-field input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .checkbox-field label {
        margin: 0;
        cursor: pointer;
    }
    
    .preview-box {
        padding: 1.5rem;
        background: var(--card);
        border: 2px solid var(--card-border);
        border-radius: 8px;
        margin: 1rem 0;
    }
    
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: var(--background);
        padding: 1.5rem 0;
        border-top: 2px solid var(--card-border);
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        z-index: 100;
    }
    
    .action-buttons .button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
    }
    
    .tab-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        background: var(--card);
        padding: 1rem;
        border-radius: 8px;
    }
    
    .tab-button {
        padding: 0.75rem 1.5rem;
        background: var(--card-bg);
        border: 2px solid var(--card-border);
        border-radius: 8px;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .tab-button:hover {
        background: var(--card);
        border-color: var(--cyan);
        transform: translateY(-2px);
    }
    
    .tab-button.active {
        background: var(--cyan);
        color: var(--background);
        border-color: var(--cyan);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .file-upload-preview {
        margin-top: 0.5rem;
    }
    
    .file-upload-preview img {
        max-width: 200px;
        max-height: 100px;
        border-radius: 5px;
        border: 2px solid var(--card-border);
    }
</style>
{% endblock %}

{% block main %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0;">‚öôÔ∏è Site Customization</h1>
            <p class="muted" style="margin: 0.5rem 0 0 0;">Complete control over your site's appearance and content</p>
        </div>
        <a href="{{ url_for('admin.dashboard') }}" class="button" style="background: var(--card); color: var(--text);">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Tab Navigation -->
        <div class="tab-container">
            <button type="button" class="tab-button active" onclick="switchTab(event, 'identity')">üè∑Ô∏è Site Identity</button>
            <button type="button" class="tab-button" onclick="switchTab(event, 'pages')">üìÑ Page Content</button>
            <button type="button" class="tab-button" onclick="switchTab(event, 'styling')">üé® Custom Styling</button>
            <button type="button" class="tab-button" onclick="switchTab(event, 'seo')">üîç SEO & Meta</button>
            <button type="button" class="tab-button" onclick="switchTab(event, 'features')">‚ö° Features</button>
            <button type="button" class="tab-button" onclick="switchTab(event, 'appearance')">üñºÔ∏è Appearance</button>
        </div>

        <!-- Tab: Site Identity -->
        <div id="tab-identity" class="tab-content active">
            <div class="section-header">
                <h2>üè∑Ô∏è Site Identity</h2>
                <p>Configure your site's name, tagline, and basic information</p>
            </div>

            <div class="form-field">
                <label for="site_name">Site Name</label>
                <input type="text" id="site_name" name="site_name" value="{{ settings.site_name }}" required>
            </div>

            <div class="form-field">
                <label for="site_tagline">Site Tagline</label>
                <input type="text" id="site_tagline" name="site_tagline" value="{{ settings.site_tagline }}">
            </div>

            <div class="form-field">
                <label for="site_description">Site Description</label>
                <textarea id="site_description" name="site_description">{{ settings.site_description }}</textarea>
            </div>

            <div class="form-grid">
                <div class="form-field">
                    <label for="site_email">Contact Email</label>
                    <input type="email" id="site_email" name="site_email" value="{{ settings.site_email or '' }}">
                </div>
                <div class="form-field">
                    <label for="site_twitter">Twitter Handle</label>
                    <input type="text" id="site_twitter" name="site_twitter" value="{{ settings.site_twitter or '' }}" placeholder="@yourbrand">
                </div>
            </div>

            <div class="form-field">
                <label for="site_github">GitHub Repository</label>
                <input type="text" id="site_github" name="site_github" value="{{ settings.site_github or '' }}" placeholder="username/repo">
            </div>
        </div>

        <!-- Tab: Page Content -->
        <div id="tab-pages" class="tab-content">
            <div class="section-header">
                <h2>üìÑ Page Content</h2>
                <p>Edit HTML content for your site's pages. Full HTML and CSS supported!</p>
            </div>

            <div class="form-field">
                <label for="welcome_page_content">Welcome Page Content (HTML)</label>
                <div class="editor-container">
                    <textarea id="welcome_page_content" name="welcome_page_content">{{ settings.welcome_page_content or '<h1>Welcome!</h1><p>This is the welcome page.</p>' }}</textarea>
                </div>
            </div>

            <div class="form-field">
                <label for="about_page_content">About Page Content (HTML)</label>
                <div class="editor-container">
                    <textarea id="about_page_content" name="about_page_content">{{ settings.about_page_content or '<h1>About Us</h1><p>Learn more about us here.</p>' }}</textarea>
                </div>
            </div>

            <div class="form-field">
                <label for="footer_content">Footer Content (HTML)</label>
                <div class="editor-container">
                    <textarea id="footer_content" name="footer_content">{{ settings.footer_content or '<p>&copy; 2025 My Blog. All rights reserved.</p>' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Tab: Custom Styling -->
        <div id="tab-styling" class="tab-content">
            <div class="section-header">
                <h2>üé® Custom Styling</h2>
                <p>Add your own CSS and JavaScript to customize every aspect of the site</p>
            </div>

            <div class="form-field">
                <label for="custom_css">Custom CSS</label>
                <small class="muted" style="display: block; margin-bottom: 0.5rem;">
                    Write custom CSS rules to style your site. Changes apply globally.
                </small>
                <div class="editor-container">
                    <textarea id="custom_css" name="custom_css">{{ settings.custom_css or '/* Add your custom CSS here */' }}</textarea>
                </div>
            </div>

            <div class="form-field">
                <label for="custom_js">Custom JavaScript</label>
                <small class="muted" style="display: block; margin-bottom: 0.5rem;">
                    Add custom JavaScript for advanced functionality. Use with caution!
                </small>
                <div class="editor-container">
                    <textarea id="custom_js" name="custom_js">{{ settings.custom_js or '// Add your custom JavaScript here' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Tab: SEO & Meta -->
        <div id="tab-seo" class="tab-content">
            <div class="section-header">
                <h2>üîç SEO & Meta Tags</h2>
                <p>Optimize your site for search engines</p>
            </div>

            <div class="form-field">
                <label for="meta_description">Meta Description</label>
                <textarea id="meta_description" name="meta_description" rows="3">{{ settings.meta_description }}</textarea>
                <small class="muted">Appears in search results (150-160 characters recommended)</small>
            </div>

            <div class="form-field">
                <label for="meta_keywords">Meta Keywords</label>
                <input type="text" id="meta_keywords" name="meta_keywords" value="{{ settings.meta_keywords }}" placeholder="blog, articles, community">
                <small class="muted">Comma-separated keywords</small>
            </div>
        </div>

        <!-- Tab: Features -->
        <div id="tab-features" class="tab-content">
            <div class="section-header">
                <h2>‚ö° Feature Toggles</h2>
                <p>Enable or disable site features</p>
            </div>

            <div class="checkbox-field">
                <input type="checkbox" id="enable_comments" name="enable_comments" {% if settings.enable_comments %}checked{% endif %}>
                <label for="enable_comments">üí¨ Enable Comments - Allow users to comment on articles</label>
            </div>

            <div class="checkbox-field">
                <input type="checkbox" id="enable_likes" name="enable_likes" {% if settings.enable_likes %}checked{% endif %}>
                <label for="enable_likes">‚ù§Ô∏è Enable Likes - Allow users to like articles</label>
            </div>

            <div class="checkbox-field">
                <input type="checkbox" id="enable_newsletter" name="enable_newsletter" {% if settings.enable_newsletter %}checked{% endif %}>
                <label for="enable_newsletter">üìß Enable Newsletter - Show newsletter subscription form</label>
            </div>

            <div class="checkbox-field">
                <input type="checkbox" id="enable_social_sharing" name="enable_social_sharing" {% if settings.enable_social_sharing %}checked{% endif %}>
                <label for="enable_social_sharing">üì§ Enable Social Sharing - Show social share buttons</label>
            </div>
        </div>

        <!-- Tab: Appearance -->
        <div id="tab-appearance" class="tab-content">
            <div class="section-header">
                <h2>üñºÔ∏è Visual Appearance</h2>
                <p>Customize colors, logo, and favicon</p>
            </div>

            <div class="form-grid">
                <div class="form-field">
                    <label for="primary_color">Primary Color</label>
                    <input type="color" id="primary_color" name="primary_color" value="{{ settings.primary_color }}">
                </div>

                <div class="form-field">
                    <label for="secondary_color">Secondary Color</label>
                    <input type="color" id="secondary_color" name="secondary_color" value="{{ settings.secondary_color }}">
                </div>
            </div>

            <div class="form-field">
                <label for="logo">Site Logo</label>
                <input type="file" id="logo" name="logo" accept="image/*">
                {% if settings.logo_path %}
                <div class="file-upload-preview">
                    <img src="{{ url_for('static', filename=settings.logo_path) }}" alt="Current logo">
                    <small class="muted" style="display: block;">Current logo</small>
                </div>
                {% endif %}
            </div>

            <div class="form-field">
                <label for="favicon">Favicon</label>
                <input type="file" id="favicon" name="favicon" accept="image/x-icon,image/png">
                {% if settings.favicon_path %}
                <div class="file-upload-preview">
                    <img src="{{ url_for('static', filename=settings.favicon_path) }}" alt="Current favicon">
                    <small class="muted" style="display: block;">Current favicon</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="submit" class="button">üíæ Save All Changes</button>
            <button type="button" onclick="previewChanges()" class="button" style="background: var(--purple);">üëÅÔ∏è Preview</button>
            <a href="{{ url_for('admin.dashboard') }}" class="button" style="background: var(--card); color: var(--text);">Cancel</a>
        </div>
    </form>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

<script>
    // Initialize CodeMirror editors
    const editors = {};
    
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Site Customization page loaded');
        console.log('Initializing CodeMirror editors...');
        
        // HTML editors
        if (document.getElementById('welcome_page_content')) {
            editors.welcome = CodeMirror.fromTextArea(document.getElementById('welcome_page_content'), {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true
            });
            console.log('Welcome editor initialized');
        }
        
        if (document.getElementById('about_page_content')) {
            editors.about = CodeMirror.fromTextArea(document.getElementById('about_page_content'), {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true
            });
        }
        
        if (document.getElementById('footer_content')) {
            editors.footer = CodeMirror.fromTextArea(document.getElementById('footer_content'), {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true
            });
        }
        
        // CSS editor
        if (document.getElementById('custom_css')) {
            editors.css = CodeMirror.fromTextArea(document.getElementById('custom_css'), {
                mode: 'css',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true
            });
        }
        
        // JavaScript editor
        if (document.getElementById('custom_js')) {
            editors.js = CodeMirror.fromTextArea(document.getElementById('custom_js'), {
                mode: 'javascript',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true
            });
        }
        
        // Refresh editors after initialization
        setTimeout(() => {
            Object.values(editors).forEach(editor => editor.refresh());
        }, 100);
    });
    
    // Tab switching function
    function switchTab(event, tabName) {
        console.log('Switching to tab:', tabName);
        
        if (!event || !event.target) {
            console.error('Event or target is null');
            return;
        }
        
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const selectedTab = document.getElementById('tab-' + tabName);
        if (selectedTab) {
            selectedTab.classList.add('active');
            console.log('Tab activated:', tabName);
        } else {
            console.error('Tab not found:', 'tab-' + tabName);
        }
        
        // Activate clicked button
        event.target.classList.add('active');
        
        // Refresh CodeMirror editors when switching to their tab
        setTimeout(() => {
            Object.values(editors).forEach(editor => {
                if (editor && editor.refresh) {
                    editor.refresh();
                }
            });
        }, 100);
    }
    
    // Preview function
    function previewChanges() {
        const confirmed = confirm('This will open your site in a new tab to preview changes.\n\nNote: Custom CSS/JS changes require saving first to take effect.\n\nContinue?');
        if (confirmed) {
            window.open('/', '_blank');
        }
    }
    
    // Before form submit, update textareas with CodeMirror content
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Save all editor content to textareas
                if (editors.welcome) editors.welcome.save();
                if (editors.about) editors.about.save();
                if (editors.footer) editors.footer.save();
                if (editors.css) editors.css.save();
                if (editors.js) editors.js.save();
            });
        }
    });
</script>
{% endblock %}
